<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROV Mission Control - Auto-Calibration v20</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    
    <style>
        * { touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }

        #ui-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 100;
            color: #00ff00;
        }

        #debug-console {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 20, 0, 0.8);
            padding: 8px 12px;
            border: 1px solid #00ff00;
            font-size: 10px;
            max-width: 200px;
            transition: opacity 1.5s ease-in-out;
            pointer-events: none;
            white-space: pre-wrap;
        }

        #depth-gauge {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 20, 0, 0.8);
            padding: 5px 12px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }

        #controls-container {
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 30px;
            pointer-events: auto;
        }

        .control-group { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .row { display: flex; gap: 8px; }

        .btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 40, 0, 0.5);
            border: 1px solid #00ff00;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #00ff00;
            font-size: 24px;
            cursor: pointer;
        }
        .btn:active { background: rgba(0, 255, 0, 0.4); }
        .label { font-size: 8px; opacity: 0.7; margin-bottom: 2px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="debug-console">SYS: Analizando modelo...</div>
        <div id="depth-gauge">D: <span id="depth-val">615.0</span>m</div>

        <div id="controls-container">
            <div class="control-group">
                <div class="btn" id="move-up">▲</div>
                <div class="row">
                    <div class="btn" id="move-left">◀</div>
                    <div class="btn" id="move-down">▼</div>
                    <div class="btn" id="move-right">▶</div>
                </div>
            </div>

            <div class="control-group">
                <span class="label">Zoom</span>
                <div class="btn" id="zoom-in">+</div>
                <div class="btn" id="zoom-out">-</div>
            </div>

            <div class="control-group">
                <span class="label">Vert</span>
                <div class="btn" id="ascend">▲</div>
                <div class="btn" id="descend">▼</div>
            </div>
        </div>
    </div>

    <a-scene renderer="antialias: true; colorManagement: true;" vr-mode-ui="enabled: true" device-orientation-permission-ui="enabled: false">
        <a-assets>
            <a-asset-item id="map-model" src="trench.glb" crossorigin="anonymous"></a-asset-item>
        </a-assets>

        <a-sky color="#00050a"></a-sky>
        <a-grid position="0 0 0" cellColor="#00ff00" opacity="0.1"></a-grid>

        <a-entity id="map-entity" gltf-model="#map-model"></a-entity>

        <a-entity id="camera-rig" position="0 1.6 0">
            <a-entity id="main-camera" camera="fov: 60" look-controls="touchEnabled: true">
                <a-light type="spot" intensity="2" distance="40" angle="45"></a-light>
                <a-light type="point" intensity="0.5" distance="10" position="0 0 -1"></a-light>
            </a-entity>
        </a-entity>

        <a-light type="hemisphere" color="#fff" groundColor="#000" intensity="0.6"></a-light>
    </a-scene>

    <script>
        const rig = document.getElementById('camera-rig');
        const cam = document.getElementById('main-camera');
        const debug = document.getElementById('debug-console');
        const depthText = document.getElementById('depth-val');
        const mapEntity = document.getElementById('map-entity');

        let activeAction = null;
        const baseDepth = 615.0;
        const moveSpeed = 0.12;

        // LÓGICA DE AUTO-CALIBRACIÓN
        mapEntity.addEventListener('model-loaded', () => {
            // 1. Obtener la malla 3D
            const obj = mapEntity.getObject3D('mesh');
            if (!obj) return;

            // 2. Calcular Bounding Box (Dimensiones reales)
            const bbox = new THREE.Box3().setFromObject(obj);
            const size = new THREE.Vector3();
            bbox.getSize(size);
            const maxDim = Math.max(size.x, size.y, size.z);

            // 3. Normalizar Escala (Objetivo: 20 unidades)
            const scaleFactor = 20 / maxDim;
            mapEntity.setAttribute('scale', `${scaleFactor} ${scaleFactor} ${scaleFactor}`);

            // 4. Centrar Modelo
            const center = new THREE.Vector3();
            bbox.getCenter(center);
            
            // Posicionar el centro del modelo a 10m frente al ROV y 2m abajo
            mapEntity.setAttribute('position', {
                x: -center.x * scaleFactor,
                y: (-center.y * scaleFactor) - 2,
                z: (-center.z * scaleFactor) - 10
            });

            // 5. Feedback y Cierre de Log
            debug.innerText = `SYS: OK\nDim: ${maxDim.toFixed(2)}m\nEscala: ${scaleFactor.toFixed(4)}`;
            debug.style.color = "#00ff00";
            setTimeout(() => { debug.style.opacity = "0"; }, 5000);
        });

        mapEntity.addEventListener('model-error', () => {
            debug.innerText = "ERR: Falló carga de modelo";
            debug.style.color = "#ff4444";
            debug.style.opacity = "1";
        });

        function updateLoop() {
            if (!activeAction) return;
            const pos = rig.getAttribute('position');
            const rot = cam.getAttribute('rotation');
            const angle = rot.y * (Math.PI / 180);
            let fov = cam.getAttribute('camera').fov;

            if (activeAction === 'move-up') { pos.x -= Math.sin(angle) * moveSpeed; pos.z -= Math.cos(angle) * moveSpeed; }
            if (activeAction === 'move-down') { pos.x += Math.sin(angle) * moveSpeed; pos.z += Math.cos(angle) * moveSpeed; }
            if (activeAction === 'move-left') { pos.x -= Math.cos(angle) * moveSpeed; pos.z += Math.sin(angle) * moveSpeed; }
            if (activeAction === 'move-right') { pos.x += Math.cos(angle) * moveSpeed; pos.z -= Math.sin(angle) * moveSpeed; }
            if (activeAction === 'ascend') pos.y += moveSpeed;
            if (activeAction === 'descend') pos.y -= moveSpeed;
            if (activeAction === 'zoom-in') fov = Math.max(10, fov - 1.2);
            if (activeAction === 'zoom-out') fov = Math.min(1000, fov + 1.2);

            rig.setAttribute('position', pos);
            cam.setAttribute('camera', 'fov', fov);
            depthText.innerText = (baseDepth - pos.y).toFixed(1);
            requestAnimationFrame(updateLoop);
        }

        const actions = ['move-up', 'move-down', 'move-left', 'move-right', 'ascend', 'descend', 'zoom-in', 'zoom-out'];
        actions.forEach(id => {
            const btn = document.getElementById(id);
            const start = (e) => { e.preventDefault(); activeAction = id; updateLoop(); };
            const stop = () => { activeAction = null; };
            btn.addEventListener('mousedown', start);
            btn.addEventListener('touchstart', start);
            window.addEventListener('mouseup', stop);
            window.addEventListener('touchend', stop);
        });

        document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
    </script>
</body>
</html>
